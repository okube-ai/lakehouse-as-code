name: job-dlt-stock-prices

parameters:
  - name: env
    default: ${vars.env}

environments:
  - environment_key: laktory
    spec:
      client: "3"
      dependencies:
        - ${vars.laktory_package}

tasks:
  - task_key: ingest
    notebook_task:
      notebook_path: /.laktory/jobs/ingest_stock_prices.py

  - task_key: ingest-metadata
    notebook_task:
      notebook_path: /.laktory/jobs/ingest_stock_metadata.py

  - task_key: pipeline
    depends_ons:
      - task_key: ingest
      - task_key: ingest-metadata
    pipeline_task:
      pipeline_id: ${resources.dlt-stock-prices.id}

  - task_key: view
    sql_task:
      query:
        query_id: ${resources.query-create-view-google-stocks.id}
      warehouse_id: ${vars.sql_tasks_warehouse_id}
    depends_ons:
      - task_key: pipeline

  - task_key: meta
    depends_ons:
      - task_key: pipeline
    python_wheel_task:
      entry_point: models.pipeline._read_and_update_tables_metadata
      package_name: laktory
      named_parameters:
        filepaths: /Workspace${vars.workspace_laktory_root}pipelines/dlt-stock-prices.json
    environment_key: laktory


access_controls:
  - group_name: account users
    permission_level: CAN_VIEW
  - group_name: role-engineers
    permission_level: CAN_MANAGE_RUN