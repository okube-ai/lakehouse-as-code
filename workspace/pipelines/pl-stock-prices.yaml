name: pl-stock-prices

catalog: ${var.env}
target: finance
development: ${var.is_dev}

clusters:
  - name : default
    node_type_id: Standard_DS3_v2
    autoscale:
      min_workers: 1
      max_workers: 2
#    init_scripts:  # TODO: Enable when supported by Databricks
#      - volumes:
#          destination: /Volumes/libraries/default/init_scripts/install_laktory.sh

libraries:
  - notebook:
      path: /pipelines/dlt_template_brz.py
  - notebook:
      path: /pipelines/dlt_template_slv.py

udfs:
  - module_name: stock_functions
    function_name: high

permissions:
  - group_name: account users
    permission_level: CAN_VIEW
  - group_name: role-engineers
    permission_level: CAN_RUN

# --------------------------------------------------------------------------- #
# Tables                                                                      #
# --------------------------------------------------------------------------- #

tables:
  - name: brz_stock_prices
    timestamp_key: data.created_at
    event_source:
      name: stock_price
      producer:
        name: yahoo-finance
    zone: BRONZE


  - name: slv_stock_prices
    timestamp_key: created_at
    table_source:
      name: brz_stock_prices
    zone: SILVER
    columns:
      - name: created_at
        type: timestamp
        spark_func_name: coalesce
        spark_func_args:
          - data._created_at

      - name: open
        type: double
        spark_func_name: coalesce
        spark_func_args:
          - data.open

      - name: close
        type: double
        spark_func_name: coalesce
        spark_func_args:
          - data.close

      - name: high
        type: double
        spark_func_name: high
        spark_func_args:
          - data.open
          - data.close

  - name: brz_stock_metadata
    event_source:
      name: stock_metadata
      read_as_stream: False
      producer:
        name: yahoo-finance
    zone: BRONZE

  - name: slv_stock_metadata
    table_source:
      name: brz_stock_metadata
      read_as_stream: False
    zone: SILVER
    columns:
      - name: symbol
        type: string
        spark_func_name: coalesce
        spark_func_args:
          - data.symbol

      - name: currency
        type: string
        spark_func_name: coalesce
        spark_func_args:
          - data.currency

      - name: first_trade_date
        type: timestamp
        spark_func_name: coalesce
        spark_func_args:
          - data.firstTradeDate