name: job-stock-prices
clusters:
  - name: main
    spark_version: 14.0.x-scala2.12
    node_type_id: Standard_DS3_v2

tasks:
  - task_key: ingest
    job_cluster_key: main
    notebook_task:
      notebook_path: /jobs/ingest_stock_prices.py
    libraries:
      - pypi:
          package: 'laktory==0.0.21'
      - pypi:
          package: yfinance

  - task_key: ingest-metadata
    job_cluster_key: main
    notebook_task:
      notebook_path: /jobs/ingest_stock_metadata.py
    libraries:
      - pypi:
          package: 'laktory==0.0.21'
      - pypi:
          package: yfinance

  - task_key: pipeline
    depends_ons:
      - task_key: ingest
      - task_key: ingest-metadata
    pipeline_task:
      pipeline_id: ${var.pl-stock-prices-id}

#  - task_key: view
#    view_task:
#      catalog_name: dev
#      schema_name: finance
#      view_name: slv_googl_stock_prices
#      definition: SELECT * from slv_stock_prices
#      warehouse_id: ${var.sql_tasks_warehouse_id}
#    depends_ons:
#      - task_key: pipeline

permissions:
  - group_name: account users
    permission_level: CAN_VIEW
  - group_name: role-engineers
    permission_level: CAN_MANAGE_RUN